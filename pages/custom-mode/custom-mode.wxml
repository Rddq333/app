<cu-custom bgColor="bg-white" isBack="{{true}}">
    <view slot="content">自定义模式</view>
</cu-custom>

<view class="custom-back-btn" bindtap="onBack">
  <van-icon name="arrow-left" size="32rpx" />
</view>

<view class="custom-header">
  <view class="custom-title">自定义模式配置</view>
  <view class="custom-subtitle">组合功能：{{modeConfigs.length}}个模式</view>
</view>

<scroll-view class="mode-tab-scroll" scroll-x>
  <view class="mode-tab-list">
    <view 
      wx:for="{{modeConfigs}}" 
      wx:key="key"
      class="mode-tab-card {{currentModeIndex === index ? 'active' : ''}}"
      style="background:{{modeColorMap[item.key]}}"
      bindtap="switchMode"
      data-index="{{index}}"
    >
      <view class="mode-tab-title">{{item.name}}</view>
      <view class="mode-tab-duration">{{modeParams[item.key].duration}}分钟</view>
    </view>
  </view>
</scroll-view>

<view 
  class="mode-param-section" 
  wx:for="{{modeConfigs}}" 
  wx:key="key" 
  wx:if="{{currentModeIndex === index}}"
  style="background:{{modeBgColorMap[item.key]}}">
  <view class="param-title">{{item.name}}参数</view>
  <block wx:if="{{item.key === 'infrared'}}">
    <van-cell title="治疗时长">
      <picker mode="selector" range="{{[10,20,30,40,50,60]}}" value="{{[10,20,30,40,50,60].indexOf(modeParams.infrared.duration)}}" bindchange="onParamChange" data-mode="infrared" data-param="duration">
        <view class="picker-value">{{modeParams.infrared.duration}}分钟</view>
      </picker>
    </van-cell>
    <van-cell title="温度设置">
      <picker mode="selector" range="{{[35,40,45,50,55,60]}}" value="{{[35,40,45,50,55,60].indexOf(modeParams.infrared.temperature)}}" bindchange="onParamChange" data-mode="infrared" data-param="temperature">
        <view class="picker-value">{{modeParams.infrared.temperature}}°C</view>
      </picker>
    </van-cell>
    <van-cell title="强度等级">
      <picker mode="selector" range="{{[1,2,3,4,5]}}" value="{{modeParams.infrared.intensity-1}}" bindchange="onParamChange" data-mode="infrared" data-param="intensity">
        <view class="picker-value">{{modeParams.infrared.intensity}}级</view>
      </picker>
    </van-cell>
    <van-cell title="治疗部位">
      <picker mode="selector" range="{{['全身','背部','腰部','腿部']}}" value="{{['全身','背部','腰部','腿部'].indexOf(modeParams.infrared.area)}}" bindchange="onParamChange" data-mode="infrared" data-param="area">
        <view class="picker-value">{{modeParams.infrared.area}}</view>
      </picker>
    </van-cell>
  </block>
  <block wx:if="{{item.key === 'hydrotherapy'}}">
    <van-cell title="水疗时长">
      <picker mode="selector" range="{{[10,20,30,40,50,60]}}" value="{{[10,20,30,40,50,60].indexOf(modeParams.hydrotherapy.duration)}}" bindchange="onParamChange" data-mode="hydrotherapy" data-param="duration">
        <view class="picker-value">{{modeParams.hydrotherapy.duration}}分钟</view>
      </picker>
    </van-cell>
    <van-cell title="水温设置">
      <picker mode="selector" range="{{[30,32,34,36,38,40,42,44,45]}}" value="{{[30,32,34,36,38,40,42,44,45].indexOf(modeParams.hydrotherapy.waterTemp)}}" bindchange="onParamChange" data-mode="hydrotherapy" data-param="waterTemp">
        <view class="picker-value">{{modeParams.hydrotherapy.waterTemp}}°C</view>
      </picker>
    </van-cell>
    <van-cell title="水压强度">
      <picker mode="selector" range="{{[1,2,3,4,5]}}" value="{{modeParams.hydrotherapy.pressure-1}}" bindchange="onParamChange" data-mode="hydrotherapy" data-param="pressure">
        <view class="picker-value">{{modeParams.hydrotherapy.pressure}}级</view>
      </picker>
    </van-cell>
    <van-cell title="按摩模式">
      <picker mode="selector" range="{{['脉冲','旋转','振动']}}" value="{{['脉冲','旋转','振动'].indexOf(modeParams.hydrotherapy.massageMode[0])}}" bindchange="onParamChange" data-mode="hydrotherapy" data-param="massageMode">
        <view class="picker-value">{{modeParams.hydrotherapy.massageMode[0]}}</view>
      </picker>
    </van-cell>
    <van-cell title="重点部位">
      <picker mode="selector" range="{{['背部','腰部','颈部']}}" value="{{['背部','腰部','颈部'].indexOf(modeParams.hydrotherapy.focusArea[0])}}" bindchange="onParamChange" data-mode="hydrotherapy" data-param="focusArea">
        <view class="picker-value">{{modeParams.hydrotherapy.focusArea[0]}}</view>
      </picker>
    </van-cell>
  </block>
  <block wx:if="{{item.key === 'moxibustion'}}">
    <van-cell title="艾灸时长">
      <picker mode="selector" range="{{[20,30,40,50,60,70,80,90]}}" value="{{[20,30,40,50,60,70,80,90].indexOf(modeParams.moxibustion.duration)}}" bindchange="onParamChange" data-mode="moxibustion" data-param="duration">
        <view class="picker-value">{{modeParams.moxibustion.duration}}分钟</view>
      </picker>
    </van-cell>
    <van-cell title="艾灸温度">
      <picker mode="selector" range="{{[40,45,50,55,60,65,70,75,80]}}" value="{{[40,45,50,55,60,65,70,75,80].indexOf(modeParams.moxibustion.temperature)}}" bindchange="onParamChange" data-mode="moxibustion" data-param="temperature">
        <view class="picker-value">{{modeParams.moxibustion.temperature}}°C</view>
      </picker>
    </van-cell>
    <van-cell title="强度等级">
      <picker mode="selector" range="{{[1,2,3,4,5]}}" value="{{modeParams.moxibustion.intensity-1}}" bindchange="onParamChange" data-mode="moxibustion" data-param="intensity">
        <view class="picker-value">{{modeParams.moxibustion.intensity}}级</view>
      </picker>
    </van-cell>
    <van-cell title="治疗部位">
      <picker mode="selector" range="{{['背部','腰部','腿部','全身']}}" value="{{['背部','腰部','腿部','全身'].indexOf(modeParams.moxibustion.area)}}" bindchange="onParamChange" data-mode="moxibustion" data-param="area">
        <view class="picker-value">{{modeParams.moxibustion.area}}</view>
      </picker>
    </van-cell>
    <van-cell title="艾灸模式">
      <picker mode="selector" range="{{['温和','雀啄','回旋']}}" value="{{['温和','雀啄','回旋'].indexOf(modeParams.moxibustion.mode)}}" bindchange="onParamChange" data-mode="moxibustion" data-param="mode">
        <view class="picker-value">{{modeParams.moxibustion.mode}}</view>
      </picker>
    </van-cell>
  </block>
  <block wx:if="{{item.key === 'herbalBath'}}">
    <van-cell title="浸泡时长">
      <picker mode="selector" range="{{[20,30,40,50,60]}}" value="{{[20,30,40,50,60].indexOf(modeParams.herbalBath.duration)}}" bindchange="onParamChange" data-mode="herbalBath" data-param="duration">
        <view class="picker-value">{{modeParams.herbalBath.duration}}分钟</view>
      </picker>
    </van-cell>
    <van-cell title="水温设置">
      <picker mode="selector" range="{{[35,37,39,41,43,45]}}" value="{{[35,37,39,41,43,45].indexOf(modeParams.herbalBath.waterTemp)}}" bindchange="onParamChange" data-mode="herbalBath" data-param="waterTemp">
        <view class="picker-value">{{modeParams.herbalBath.waterTemp}}°C</view>
      </picker>
    </van-cell>
    <van-cell title="中药类型">
      <picker mode="selector" range="{{['艾草','当归','川芎','黄芪']}}" value="{{['艾草','当归','川芎','黄芪'].indexOf(modeParams.herbalBath.herbType)}}" bindchange="onParamChange" data-mode="herbalBath" data-param="herbType">
        <view class="picker-value">{{modeParams.herbalBath.herbType}}</view>
      </picker>
    </van-cell>
    <van-cell title="浓度等级">
      <picker mode="selector" range="{{[1,2,3,4,5]}}" value="{{modeParams.herbalBath.concentration-1}}" bindchange="onParamChange" data-mode="herbalBath" data-param="concentration">
        <view class="picker-value">{{modeParams.herbalBath.concentration}}级</view>
      </picker>
    </van-cell>
    <van-cell title="浸泡模式">
      <picker mode="selector" range="{{['浸泡','冲淋']}}" value="{{['浸泡','冲淋'].indexOf(modeParams.herbalBath.mode)}}" bindchange="onParamChange" data-mode="herbalBath" data-param="mode">
        <view class="picker-value">{{modeParams.herbalBath.mode}}</view>
      </picker>
    </van-cell>
  </block>
  <block wx:if="{{item.key === 'musicTherapy'}}">
    <van-cell title="音乐时长">
      <picker mode="selector" range="{{[10,15,20,25,30,40,50,60]}}" value="{{[10,15,20,25,30,40,50,60].indexOf(modeParams.musicTherapy.duration)}}" bindchange="onParamChange" data-mode="musicTherapy" data-param="duration">
        <view class="picker-value">{{modeParams.musicTherapy.duration}}分钟</view>
      </picker>
    </van-cell>
    <van-cell title="音乐类型">
      <picker mode="selector" range="{{['α波','θ波','自然音','器乐']}}" value="{{['α波','θ波','自然音','器乐'].indexOf(modeParams.musicTherapy.genre)}}" bindchange="onParamChange" data-mode="musicTherapy" data-param="genre">
        <view class="picker-value">{{modeParams.musicTherapy.genre}}</view>
      </picker>
    </van-cell>
    <van-cell title="音量大小">
      <picker mode="selector" range="{{[0,10,20,30,40,50,60,70,80,90,100]}}" value="{{[0,10,20,30,40,50,60,70,80,90,100].indexOf(modeParams.musicTherapy.volume)}}" bindchange="onParamChange" data-mode="musicTherapy" data-param="volume">
        <view class="picker-value">{{modeParams.musicTherapy.volume}}%</view>
      </picker>
    </van-cell>
    <van-cell title="频率设置">
      <picker mode="selector" range="{{[200,300,400,500,600,700,800]}}" value="{{[200,300,400,500,600,700,800].indexOf(modeParams.musicTherapy.frequency)}}" bindchange="onParamChange" data-mode="musicTherapy" data-param="frequency">
        <view class="picker-value">{{modeParams.musicTherapy.frequency}}Hz</view>
      </picker>
    </van-cell>
    <van-cell title="节奏BPM">
      <picker mode="selector" range="{{[40,60,80,100,120]}}" value="{{[40,60,80,100,120].indexOf(modeParams.musicTherapy.rhythm)}}" bindchange="onParamChange" data-mode="musicTherapy" data-param="rhythm">
        <view class="picker-value">{{modeParams.musicTherapy.rhythm}}BPM</view>
      </picker>
    </van-cell>
  </block>
  <block wx:if="{{item.key === 'aromatherapy'}}">
    <van-cell title="香氛时长">
      <picker mode="selector" range="{{[15,20,30,35,40,50,60]}}" value="{{[15,20,30,35,40,50,60].indexOf(modeParams.aromatherapy.duration)}}" bindchange="onParamChange" data-mode="aromatherapy" data-param="duration">
        <view class="picker-value">{{modeParams.aromatherapy.duration}}分钟</view>
      </picker>
    </van-cell>
    <van-cell title="精油类型">
      <picker mode="selector" range="{{['薰衣草','柠檬','薄荷','玫瑰','橙花','尤加利']}}" value="{{['薰衣草','柠檬','薄荷','玫瑰','橙花','尤加利'].indexOf(modeParams.aromatherapy.oilType)}}" bindchange="onParamChange" data-mode="aromatherapy" data-param="oilType">
        <view class="picker-value">{{modeParams.aromatherapy.oilType}}</view>
      </picker>
    </van-cell>
    <van-cell title="浓度等级">
      <picker mode="selector" range="{{[1,2,3,4,5]}}" value="{{modeParams.aromatherapy.concentration-1}}" bindchange="onParamChange" data-mode="aromatherapy" data-param="concentration">
        <view class="picker-value">{{modeParams.aromatherapy.concentration}}级</view>
      </picker>
    </van-cell>
    <van-cell title="喷雾模式">
      <picker mode="selector" range="{{['喷雾','扩香','间歇']}}" value="{{['喷雾','扩香','间歇'].indexOf(modeParams.aromatherapy.mode)}}" bindchange="onParamChange" data-mode="aromatherapy" data-param="mode">
        <view class="picker-value">{{modeParams.aromatherapy.mode}}</view>
      </picker>
    </van-cell>
    <van-cell title="强度等级">
      <picker mode="selector" range="{{[1,2,3,4,5]}}" value="{{modeParams.aromatherapy.intensity-1}}" bindchange="onParamChange" data-mode="aromatherapy" data-param="intensity">
        <view class="picker-value">{{modeParams.aromatherapy.intensity}}级</view>
      </picker>
    </van-cell>
  </block>
</view>

<!-- 运行信息 -->
<view class="running-info" wx:if="{{isRunning}}">
  <view class="section-title">运行信息</view>
  <van-cell-group>
    <van-cell title="运行时间" value="{{runningTime}}" />
    <van-cell title="剩余时间" value="{{remainingTime}}" />
    <van-cell title="总时长" value="{{modeParams[modeConfigs[currentModeIndex].key].duration}}分钟" />
    <van-cell title="当前模式" value="{{modeConfigs[currentModeIndex].name}}" />
    <van-cell title="运行状态" value="{{status === 'running' ? '运行中' : '已暂停'}}" />
  </van-cell-group>
</view>

<!-- 提示信息 -->
<view class="tip-info" wx:if="{{!isRunning && modeConfigs.length === 0}}">
  <van-cell-group>
    <van-cell title="提示" value="请先选择理疗模式" />
  </van-cell-group>
</view>

<!-- 控制按钮 -->
<view class="control-buttons">
  <van-button 
    type="{{isRunning ? (status === 'paused' ? 'primary' : 'warning') : 'primary'}}" 
    size="large" 
    block 
    bind:tap="{{isRunning ? (status === 'paused' ? 'resumeMode' : 'pauseMode') : 'startCustomMode'}}"
    loading="{{loading}}"
    disabled="{{!isRunning && modeConfigs.length === 0}}"
    custom-class="round-btn"
  >
    {{isRunning ? (status === 'paused' ? '继续' : '暂停') : '启动'}}
  </van-button>
  
  <van-button 
    wx:if="{{isRunning}}" 
    type="danger" 
    size="large" 
    block 
    bind:tap="stopMode"
    style="margin-top: 10px;"
    custom-class="round-btn"
  >
    结束
  </van-button>
</view>
